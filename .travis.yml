language: python
python:
  - "2.7"

# Use the new travis docker based infrastructure
sudo: false

# Install required packages
addons:
  postgresql: "9.3"
  apt:
    packages:
# libhdf4-alt-dev is not available on travis CI. It would appear this package is not required by tests at this time
# TODO: Check if this dependency is truly required
#    - libhdf4-alt-dev
    - libhdf5-serial-dev
    - libnetcdf-dev
# libgdal-dev has a packaging conflict on travis ci which causes it to uninstall postgis.
# TODO: Check if this dependency is truly required
#    - libgdal-dev

# Command to install miniconda to build test environment
before_install:
  # Python and packages
  - if [[ "$TRAVIS_PYTHON_VERSION" == "2.7" ]]; then
      travis_retry wget https://repo.continuum.io/miniconda/Miniconda-latest-Linux-x86_64.sh -O miniconda.sh;
    else
      travis_retry wget http://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh;
    fi
  - bash miniconda.sh -b -p $HOME/miniconda
  - export PATH="$HOME/miniconda/bin:$PATH"
  - hash -r
  - conda config --set always_yes yes --set changeps1 no
  # Add Jess Robertson (CSIRO) binstar channel to get custom builds for some utilities
  - conda config --add channels jesserobertson
  - travis_retry conda update -q conda
  # Useful for debugging any issues with conda
  - conda info -a
  # Test databases and data
  - travis_retry wget https://github.com/data-cube/agdc-v2-data/raw/master/sample_dbs/gdf_modis_20150710.backup
  - travis_retry wget https://github.com/data-cube/agdc-v2-data/raw/master/sample_dbs/gdf_landsat_20150710.backup
  # TODO: Add download of test data when available in a suitable size
  - cd gdf_database
  # Travis logs will show a WARNING regarding the "gdf_modis" does not exist, and Error regarding SCHEMA topology
  # These are to be expected and can be safely ignored. It is a consequence of restoring a backup after creating an empty
  # database that ensures the database setup scripts are working
  - ./gdf_db_setup.sh
  - ./create_db_from_backup.sh gdf_test_modis ../gdf_modis_20150710.backup
  - ./create_db_from_backup.sh gdf_test_ls ../gdf_landsat_20150710.backup
  - cd ..

install:
  - conda create -q -n test-agdc python=$TRAVIS_PYTHON_VERSION nose pip sphinx numpy scipy matplotlib gdal netCDF4 numexpr psycopg2 coverage python-coveralls flake8 pylint
  - source activate test-agdc
  - travis_retry pip install -r requirements.txt 
  - python setup.py install

script:
  # Check all files other than 'compat.py'.
  #   -> compat.py contains both Python 2 and 3 syntax, so will fail lint checks.
  #   -> 'datacube_ingester.py' is broken and soon to be replaced at time of writing.
  - export py_files=$( find datacube -iname '*.py' -not -iname 'compat.py' -not -iname 'datacube_ingester.py' )

  - pylint --reports no ${py_files}
  - pep8 --max-line-length 120 ${py_files}
  # Check for basic Python 3 incompatiblities.
  - pylint --py3k --reports no ${py_files}

  - py.test --cov datacube datacube tests

after_success:
  - coveralls
